variant: fcos
version: 1.4.0
passwd:
  users:
    - name: eugene
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDMES8LZ9z7Rl38/G9gMddRLJiSu9FoEKtu//rm60yEKXmEOh9l4/YsRwPbaqJmWLtElz6zreboxaakPK2TnzT24jA6TJdsWYno5yJB1YypNEAyEzqjNcDbHRY1YP1U2sE4DO2Uq8LLZPGsgppS85L4aIwCHjj0VxAp82jmosaK7Hijot8VqTcNrsEgO5GIF9ZHhNm4i5vzck79Jww9w1+0O2fTATi+mRXYNc4mJoG1FVN471sMtyvJIFmGKorzZ2tUNdpz0cQKtWoF51psmEOJ33pqOMAXNPOSWAmO4JfcS6K3BcrF2UenC8FMI+B2gA42LkPy8pMRqmjNDKHmvxD103qtisnsXgHpSH3NCImtvjK2vNGalzrrElNJdpRW+uHjiQDUm7WSPG6UtwJf/is0Sd6GCQ3ZHlUoE5DhH6pHeZMssrx8mbVaCFjaWO6GtcM9Q7Mpo03/1n1ecOTg8dpWvt25kFurtIuW+m8BtHVj/efmm91d02OkbYkoIBTHyTk=
      groups:
        - wheel
        - sudo
systemd:
  units:
  - name: postinst.service
    enabled: true
    contents: |
        [Unit]
        Description=Initial System Setup

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/systemctl restart systemd-resolved
        ExecStart=/usr/bin/rpm-ostree install firewalld qemu-guest-agent unzip curl unzip 
        ExecStart=/usr/bin/rpm-ostree override remove cifs-utils samba-common-libs samba-client-libs libsmbclient libwbclient samba-common sssd-krb5-common sssd-ipa sssd-nfs-idmap sssd-ldap sssd-client sssd-ad sssd-common sssd-krb5 sssd-common-pac
        ExecStart=/bin/systemctl --no-block reboot

        [Install]
        WantedBy=multi-user.target   
  - name: instnomad.service
    enabled: true
    contents: |    
      [Unit]
      Description=Install Nomad to system

      [Service]
      Type=oneshot
      ExecStart=/usr/bin/curl -L -o nomad_1.5.6_linux_386.zip https://https://releases.hashicorp.com/nomad/1.5.6/nomad_1.5.6_linux_386.zip
      ExecStart=/usr/bin/unzip nomad_1.5.6_linux_386.zip
      ExecStart=/usr/bin/mv nomad /usr/local/bin/

      [Install]
      WantedBy=multi-user.target         
  - name: cni.service
    enabled: true
    contents: |    
      [Unit]
      Description=Initial System Setup CNI 

      [Service]
      Type=oneshot
      ExecStart=/usr/bin/curl -L -o cni-plugins.tgz "https://github.com/containernetworking/plugins/releases/download/v1.0.0/cni-plugins-linux-$( [ $(uname -m) = aarch64 ] && echo arm64 || echo amd64)"-v1.0.0.tgz && \
      ExecStart=/usr/bin/mkdir -p /opt/cni/bin && \
      ExecStart=/usr/bin/tar -C /opt/cni/bin -xzf cni-plugins.tgz
      ExecStart=/usr/bin/echo 1 | sudo tee /proc/sys/net/bridge/bridge-nf-call-arptables 
      ExecStart=/usr/bin/echo 1 | sudo tee /proc/sys/net/bridge/bridge-nf-call-ip6tables
      ExecStart=/usr/bin/echo 1 | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables

      [Install]
      WantedBy=multi-user.target
  - name: podmansetup.service
    enabled: true
    contents: |    
      [Unit]
      Description=Set up Podman service
      Requires=podman.service

      [Service]
      User=root
      WorkingDirectory=/home
      ExecStart=podman system service -t 0 & unix:///var/run/podman.sock
      Restart=no

      [Service]
      Type=oneshot

      [Install]
      WantedBy=multi-user.target
  - name: podman.service
    enabled: true
  - name: rpm-ostree-countme.timer
    enabled: false
    mask: true
  - name: sshd.service
    enabled: false
  - name: sshd.socket
    enabled: true
storage:
  files:
    - path: /etc/ssh/sshd_config.d/20-enable-passwords.conf
      mode: 0644
      contents:
        inline: |
          # Fedora CoreOS disables SSH password login by default.
          # Enable it.
          # This file must sort before 40-disable-passwords.conf.
          PasswordAuthentication yes